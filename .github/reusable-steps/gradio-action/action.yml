name: Run Gradio app until ready

inputs:
  script:
    required: true
  project:
    required: true
  timeout:
    required: false
    default: 3600

runs:
  using: 'composite'
  steps:
    - name: Run Gradio App (Linux/Mac)
      if: ${{ runner.os != 'Windows' }}
      shell: bash
      run: |
        cd ${{ inputs.project }}

        if [[ "${{ inputs.script }}" == *"test.py" ]]; then
          echo "Detected test.py. Running in foreground so it controls FastAPI lifecycle."
          python ${{ inputs.script }} 2>&1 | tee gradio_log.txt
          exit $?
        else
          if [ "${{ runner.os }}" == "Linux" ]; then
            xvfb-run python ${{ inputs.script }} 2>&1 | tee gradio_log.txt &
          else
            python ${{ inputs.script }} 2>&1 | tee gradio_log.txt &
          fi
        fi

        app_pid=$(ps aux | grep -i '[p]ython ${{ inputs.script }}' | awk '{print $2}')

        timeout ${{ inputs.timeout }} bash -c "
          (tail -f gradio_log.txt &) | awk '/Demo is ready!/ {exit}'
        "

        status=$?

        echo "Stopping the Gradio app..."
        pkill -P $app_pid || echo "No child processes to kill."
        kill $app_pid || echo "App process already terminated."
        wait $app_pid || echo "App process cleanup complete."

        exit $status

    - name: Run Gradio App (Windows)
      if: ${{ runner.os == 'Windows' }}
      shell: powershell
      run: |
        cd ${{ inputs.project }}
        Write-Output "==> Running script: ${{ inputs.script }}"

        $logFile = "gradio_log.txt"
        $proc = Start-Process -NoNewWindow -FilePath "python" -ArgumentList "${{ inputs.script }}" `
                 -RedirectStandardOutput $logFile -RedirectStandardError $logFile -PassThru
        $app_pid = $proc.Id
        Write-Output "==> App PID: $app_pid"

        $start_time = Get-Date
        $timeout = ${{ inputs.timeout }}
        $success = $false

        if ("${{ inputs.script }}" -like "*test.py") {
          Write-Output "==> test.py detected. Waiting for process to complete..."
          $proc.WaitForExit()
          Get-Content -Path $logFile
          if ($proc.ExitCode -eq 0) {
            $success = $true
          } else {
            Write-Error "Script exited with code $($proc.ExitCode)"
          }
        } else {
          Write-Output "==> Waiting for readiness message: 'Demo is ready!'"
          while ($true) {
            if (Test-Path $logFile) {
              $content = Get-Content -Path $logFile -Raw
              if ($content -match "Demo is ready!") {
                $success = $true
                break
              }
            }
            if (((Get-Date) - $start_time).TotalSeconds -ge $timeout) {
              Write-Output "==> Timeout waiting for readiness."
              break
            }
            Start-Sleep -Seconds 2
          }

          Write-Output "==> Stopping background process..."
          Stop-Process -Id $app_pid -Force -ErrorAction SilentlyContinue
        }

        Write-Output "==> Gradio Log Output:"
        Get-Content -Path $logFile

        if (-not $success) {
          exit 1
        }
